[{"id":"55fea016.edc5d","type":"tab","label":"asset_tracking","disabled":false,"info":""},{"id":"d34781e0.804f88","type":"Notified_IM","z":"55fea016.edc5d","server":"3c6b498c.2449ee","name":"Message notification","filter":"","filterContact":"","filterCompany":"","ignorechat":false,"ignoregroupchat":false,"x":130,"y":160,"wires":[["a4f8710b.5a55b8","75daa40.ac2cb5c","4cfc3b6c.832a1c"]]},{"id":"1fddb37e.596fed","type":"dialogflowv2","z":"55fea016.edc5d","dialogflow":"37fa3ed7.4d8162","language":"en","debug":true,"variable":"topic","x":480,"y":1080,"wires":[["3cf40a0.8055476","2129bba3.9b1c04"]]},{"id":"99a05b24.a93658","type":"Send_IM","z":"55fea016.edc5d","server":"3c6b498c.2449ee","name":"Response","destJid":"","x":670,"y":1740,"wires":[]},{"id":"ba4668b1.1a602","type":"change","z":"55fea016.edc5d","name":"Response from Tensorflow","rules":[{"t":"set","p":"payload.content","pt":"msg","to":"answer","tot":"flow"},{"t":"set","p":"payload.destJid","pt":"msg","to":"userId","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":1740,"wires":[["99a05b24.a93658","e0d4d967.16043"]]},{"id":"3cf40a0.8055476","type":"debug","z":"55fea016.edc5d","name":"dialogflow response","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"_dialogflow","targetType":"msg","x":680,"y":1180,"wires":[]},{"id":"e0d4d967.16043","type":"debug","z":"55fea016.edc5d","name":"chatbot response","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":690,"y":1820,"wires":[]},{"id":"4ca13f5f.93b5c","type":"change","z":"55fea016.edc5d","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"messageContent","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":1080,"wires":[["1fddb37e.596fed"]]},{"id":"2129bba3.9b1c04","type":"function","z":"55fea016.edc5d","name":"manage answer","func":"// set content of the answer in the flow to retrieve it later\nflow.set(\"answer\",msg._dialogflow.fulfillmentText)\n\n//manage building and floor\nflow.building = msg._dialogflow//line not finished\n\n//manage entity recognition\nmsg.param = {\n    $name:msg._dialogflow//line not finished\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1080,"wires":[["28b92b1.7f303d4"]]},{"id":"a4f8710b.5a55b8","type":"debug","z":"55fea016.edc5d","name":"notification content","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":290,"y":80,"wires":[]},{"id":"ad898b79.7f9e","type":"debug","z":"55fea016.edc5d","name":"authentification result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":420,"y":420,"wires":[]},{"id":"985b01f4.75a4","type":"authenticate","z":"55fea016.edc5d","name":"Authenticate","email":"lucas.charpentier@imt-atlantique.net","password":"Serez@78","appid":"5dcac9baeaa5b8329fbb5bad","appsecret":"","x":210,"y":340,"wires":[["ad898b79.7f9e","a9d26045.405ea"]]},{"id":"a9d26045.405ea","type":"function","z":"55fea016.edc5d","name":"set access token","func":"global.set(\"OAS_access_token\",msg.payload.body.access_token)","outputs":1,"noerr":0,"x":450,"y":340,"wires":[["19d69753.a55e71"]]},{"id":"1f916b3f.7401f5","type":"debug","z":"55fea016.edc5d","name":"site obtention result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":420,"wires":[]},{"id":"8c31eae.2058e98","type":"get_assetcategories","z":"55fea016.edc5d","name":"","x":1700,"y":500,"wires":[["78f0e3b7.859c7c","869dc93f.56ea4"]]},{"id":"4816064e.a07578","type":"function","z":"55fea016.edc5d","name":"find current site","func":"//flow.set(\"OAS_siteID\",msg.payload[0].id)\nreturn msg;","outputs":1,"noerr":0,"x":1400,"y":340,"wires":[["81da02df.0f819"]]},{"id":"78f0e3b7.859c7c","type":"debug","z":"55fea016.edc5d","name":"asset categories obtention result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2130,"y":440,"wires":[]},{"id":"17d1ba0c.9a6e4e","type":"debug","z":"55fea016.edc5d","name":"building floor obtention result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2080,"y":280,"wires":[]},{"id":"81da02df.0f819","type":"get_buildingsandfloors","z":"55fea016.edc5d","name":"","x":1700,"y":340,"wires":[["17d1ba0c.9a6e4e","62481d2.84c5464"]]},{"id":"636612ab.7f23f4","type":"get_allassets","z":"55fea016.edc5d","name":"","x":1670,"y":660,"wires":[["2ddb9add.1f6bee","7158e5c7.5153d4"]]},{"id":"2ddb9add.1f6bee","type":"debug","z":"55fea016.edc5d","name":"asset obtention result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2100,"y":600,"wires":[]},{"id":"4cfc3b6c.832a1c","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"fixed","sql":"CREATE TABLE site(id VARCHAR(255) PRIMARY KEY,name VARCHAR(255),type VARCHAR(255));","name":"create table site","x":450,"y":160,"wires":[["77786700.9f6c78","29720153.be407e"]]},{"id":"77786700.9f6c78","type":"debug","z":"55fea016.edc5d","name":"site table creation output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":650,"y":60,"wires":[]},{"id":"fc40c7da.7c304","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"msg.topic","sql":"","name":"updates site info","x":1160,"y":340,"wires":[["4816064e.a07578","fc66096a.bcd"]]},{"id":"b4dddfd9.4acd88","type":"function","z":"55fea016.edc5d","name":"prepare site info update","func":"flow.set(\"OAS_siteID\",msg.payload[0].id); // temporary line\nmsg.topic = \"INSERT INTO site(id,name,type) VALUES\";\nmsg.payload.forEach(site => {\n    msg.topic += \"('\" + site.id + \"','\" + site.name + \"','\" + site.type + \"'),\";\n});\nmsg.topic = msg.topic.slice(0,-1) + ';'; // replacing the last character of the query\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":340,"wires":[["fc40c7da.7c304","d21c36af.b1f138"]]},{"id":"19d69753.a55e71","type":"get_sites","z":"55fea016.edc5d","name":"","x":660,"y":340,"wires":[["b4dddfd9.4acd88","1f916b3f.7401f5"]]},{"id":"d21c36af.b1f138","type":"debug","z":"55fea016.edc5d","name":"site update query","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"topic","targetType":"msg","x":1130,"y":420,"wires":[]},{"id":"fc66096a.bcd","type":"debug","z":"55fea016.edc5d","name":"site update result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1410,"y":420,"wires":[]},{"id":"62481d2.84c5464","type":"function","z":"55fea016.edc5d","name":"prepare buildings info update","func":"// First query (retrieves buildings)\nmsg.topic = \"INSERT INTO building(id,name,site) VALUES\";\nmsg.payload.forEach(building => {\n    msg.topic += \"('\" + building.id + \"','\" + building.name + \"','\" + building.site + \"'),\";\n});\nmsg.topic = msg.topic.slice(0,-1) + ';'; // replacing the last character of the query\n// Second query (retrieves floors)\nmsg.topic += \"INSERT INTO floor(id,name,building) VALUES\";\nmsg.payload.forEach(floor => {\n    msg.topic += \"('\" + floor.id + \"','\" + floor.name + \"','\" + floor.building + \"'),\";\n});\nmsg.topic = msg.topic.slice(0,-1) + ';'; // replacing the last character of the query\nreturn msg;","outputs":1,"noerr":0,"x":2080,"y":340,"wires":[["3493df53.96c89","66779670.410b78"]]},{"id":"3493df53.96c89","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"msg.topic","sql":"","name":"updates building info","x":2520,"y":340,"wires":[["9b7de74f.7178d8","8c31eae.2058e98"]]},{"id":"66779670.410b78","type":"debug","z":"55fea016.edc5d","name":"building info query","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"topic","targetType":"msg","x":2510,"y":280,"wires":[]},{"id":"9b7de74f.7178d8","type":"debug","z":"55fea016.edc5d","name":"building table update output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":2800,"y":340,"wires":[]},{"id":"869dc93f.56ea4","type":"function","z":"55fea016.edc5d","name":"prepare categories info update","func":"msg.topic = \"INSERT INTO asset_category(id,name,site) VALUES\";\nmsg.payload.forEach(category => {\n    msg.topic += \"('\" + category.id + \"','\" + category.name + \"','\" + category.site + \"'),\";\n});\nmsg.topic = msg.topic.slice(0,-1) + ';'; // replacing the last character of the query\nreturn msg;","outputs":1,"noerr":0,"x":2090,"y":500,"wires":[["69c0078a.5076c","4f496161.ea72c"]]},{"id":"4f496161.ea72c","type":"debug","z":"55fea016.edc5d","name":"category info query","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"topic","targetType":"msg","x":2510,"y":440,"wires":[]},{"id":"69c0078a.5076c","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"msg.topic","sql":"","name":"updates category info","x":2520,"y":500,"wires":[["4bf08f27.e45738","636612ab.7f23f4"]]},{"id":"4bf08f27.e45738","type":"debug","z":"55fea016.edc5d","name":"category table update output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":2880,"y":500,"wires":[]},{"id":"7158e5c7.5153d4","type":"function","z":"55fea016.edc5d","name":"prepare asset info update","func":"msg.topic = \"INSERT INTO asset(id,name,site,category,mac_address) VALUES\";\nmsg.payload.forEach(asset => {\n    msg.topic += \"('\" + asset.id + \"','\" + asset.name + \"','\" + asset.site + \"','\" + asset.category + \"','\" + asset.tag.macAddress + \"'),\";\n});\nmsg.topic = msg.topic.slice(0,-1) + ';'; // replacing the last character of the query\nreturn msg;","outputs":1,"noerr":0,"x":2070,"y":660,"wires":[["cfad5052.ca97d8","5c3c6abf.d85bcc"]]},{"id":"cfad5052.ca97d8","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"msg.topic","sql":"","name":"updates asset info","x":2490,"y":660,"wires":[["3321e014.b104c","4fb446ea.d3d698"]]},{"id":"5c3c6abf.d85bcc","type":"debug","z":"55fea016.edc5d","name":"asset info query","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"topic","targetType":"msg","x":2480,"y":600,"wires":[]},{"id":"3321e014.b104c","type":"debug","z":"55fea016.edc5d","name":"asset table update output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":2850,"y":660,"wires":[]},{"id":"8dbe89b1.1747c","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"fixed","sql":"CREATE TABLE floor(id VARCHAR(255) PRIMARY KEY,name VARCHAR(255),building VARCHAR(255));","name":"create table floor","x":1930,"y":160,"wires":[["746caab4.62c304","985b01f4.75a4"]]},{"id":"78acc66c.d8a57","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"fixed","sql":"CREATE TABLE asset(id VARCHAR(255) PRIMARY KEY,name VARCHAR(255),site VARCHAR(255),category VARCHAR(255),mac_address VARCHAR(255));","name":"create table asset","x":1370,"y":160,"wires":[["83eeddc2.664fd8","62b83e9c.6b257"]]},{"id":"29720153.be407e","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"fixed","sql":"CREATE TABLE asset_category(id VARCHAR(255) PRIMARY KEY,name VARCHAR(255),site VARCHAR(255),synonym VARCHAR(255));","name":"create table asset_category","x":720,"y":160,"wires":[["645192b6.8418b4","e548ba92.3ab1b8"]]},{"id":"83eeddc2.664fd8","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"fixed","sql":"CREATE TABLE building(id VARCHAR(255) PRIMARY KEY,name VARCHAR(255),site VARCHAR(255));","name":"create table building","x":1620,"y":160,"wires":[["8dbe89b1.1747c","61719ee7.31c17"]]},{"id":"645192b6.8418b4","type":"debug","z":"55fea016.edc5d","name":"category table creation output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":970,"y":60,"wires":[]},{"id":"62b83e9c.6b257","type":"debug","z":"55fea016.edc5d","name":"asset table creation output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1620,"y":60,"wires":[]},{"id":"61719ee7.31c17","type":"debug","z":"55fea016.edc5d","name":"building table creation output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1940,"y":60,"wires":[]},{"id":"746caab4.62c304","type":"debug","z":"55fea016.edc5d","name":"floor table creation output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":2240,"y":160,"wires":[]},{"id":"75daa40.ac2cb5c","type":"change","z":"55fea016.edc5d","name":"register user id and content","rules":[{"t":"set","p":"userId","pt":"flow","to":"payload.fromJid","tot":"msg"},{"t":"set","p":"messageContent","pt":"flow","to":"payload.content","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":440,"y":240,"wires":[[]]},{"id":"7255fb07.cdb244","type":"sqlite","z":"55fea016.edc5d","mydb":"8aa712e4.3b9af8","sqlquery":"prepared","sql":"SELECT name,synonyms FROM synonym WHERE name IN ($names);","name":"retrieves synonyms","x":960,"y":840,"wires":[["ee6d0f22.08a598"]]},{"id":"4fb446ea.d3d698","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"fixed","sql":"SELECT name FROM asset_category;","name":"retrieve names","x":320,"y":840,"wires":[["2295cf3f.2056f8"]]},{"id":"2295cf3f.2056f8","type":"function","z":"55fea016.edc5d","name":"prepare synonym query","func":"msg.param = {\n    $names:\"\"\n};\nmsg.payload.forEach(category => {\n    msg.param.$names += category.name + \",\";\n})\nmsg.param.$names = msg.param.$names.slice(0,-1);\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":840,"wires":[["7255fb07.cdb244"]]},{"id":"b6d9701e.ae0eb8","type":"debug","z":"55fea016.edc5d","name":"insert dialogflow API node here","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1460,"y":860,"wires":[]},{"id":"ee6d0f22.08a598","type":"function","z":"55fea016.edc5d","name":"inject entities into dialogflow","func":"// this has to be done\nreturn msg;","outputs":1,"noerr":0,"x":1250,"y":920,"wires":[["4ca13f5f.93b5c","b6d9701e.ae0eb8"]]},{"id":"28b92b1.7f303d4","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"prepared","sql":"SELECT a.id,a.mac_adress FROM asset AS a JOIN category AS c ON a.category=c.id WHERE c.name=$name;","name":"list mac adress","x":980,"y":1080,"wires":[["343e2fc7.a14df"]]},{"id":"a0944c18.e7c7a8","type":"latest_locationofasset","z":"55fea016.edc5d","name":"","x":1010,"y":1320,"wires":[["3ba84579.9efe52"]]},{"id":"f452b396.d681b","type":"function","z":"55fea016.edc5d","name":"mac address configuration","func":"msg.macAddress = flow.addresses[flow.iteration].mac_address;\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":1320,"wires":[["a0944c18.e7c7a8"]]},{"id":"343e2fc7.a14df","type":"change","z":"55fea016.edc5d","name":"iniitialize loop","rules":[{"t":"set","p":"iteration","pt":"flow","to":"0","tot":"num"},{"t":"set","p":"addresses","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1200,"y":1080,"wires":[["b32731df.03cbb8"]]},{"id":"b32731df.03cbb8","type":"function","z":"55fea016.edc5d","name":"for loop","func":"if (flow.iteration < flow.addresses.length) {\n    return msg\n}","outputs":1,"noerr":0,"x":1420,"y":1080,"wires":[["f452b396.d681b"]]},{"id":"e548ba92.3ab1b8","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"fixed","sql":"CREATE TABLE position(asset_id VARCHAR(255) PRIMARY KEY,position VARCHAR(255));","name":"create table position","x":1040,"y":160,"wires":[["78acc66c.d8a57","752cfc41.276ec4"]]},{"id":"752cfc41.276ec4","type":"debug","z":"55fea016.edc5d","name":"position table creation output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1290,"y":60,"wires":[]},{"id":"3ba84579.9efe52","type":"function","z":"55fea016.edc5d","name":"position insertion preparation","func":"msg.param = {\n    $pos:msg.output,\n    $asset:flow.addresses[flow.iteration].id\n};\nreturn msg;","outputs":1,"noerr":0,"x":1290,"y":1320,"wires":[["dff3c970.96b948"]]},{"id":"dff3c970.96b948","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"prepared","sql":"INSERT INTO position(asset_id,position) VALUES($asset,$pos);","name":"position insertion","x":1570,"y":1320,"wires":[["b32731df.03cbb8","bbe2bdf3.a75fe"]]},{"id":"bbe2bdf3.a75fe","type":"function","z":"55fea016.edc5d","name":"loop breaker","func":"if (flow.iteration===flow.addresses.length) {\n    return msg;\n}","outputs":1,"noerr":0,"x":1790,"y":1320,"wires":[["b9b4f21d.31f32"]]},{"id":"b9b4f21d.31f32","type":"sqlite","z":"55fea016.edc5d","mydb":"bee73170.35c9b","sqlquery":"prepared","sql":"SELECT a.name,a.position FROM position AS p JOIN asset AS a ON p.asset_id=a.id ORDER BY p.position;","name":"sorting assets (not finished)","x":400,"y":1500,"wires":[["e91be92a.4b3858"]]},{"id":"e91be92a.4b3858","type":"change","z":"55fea016.edc5d","name":"keep closest asset only","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload[0]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":1500,"wires":[["ba4668b1.1a602","6b4f7c81.b02734"]]},{"id":"6b4f7c81.b02734","type":"function","z":"55fea016.edc5d","name":"Description of object","func":"var name = msg.payload.name;\nvar position = msg.payload.position;\nmsg.payload.content = \"The object is \" + name + \" and is located at \" + position;\nmsg.payload.destJid = flow.userId;\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":1500,"wires":[["e67eb492.c2151"]]},{"id":"e67eb492.c2151","type":"Send_IM","z":"55fea016.edc5d","server":"3c6b498c.2449ee","name":"Response description","destJid":"","x":1370,"y":1500,"wires":[]},{"id":"3c6b498c.2449ee","type":"Login","z":"","name":"chat test","host":"sandbox","autoLogin":true,"proxyHost":"","proxyPort":"","proxyProto":"","ackIM":false},{"id":"37fa3ed7.4d8162","type":"dialogflowv2-token","z":"","name":"assetTracking"},{"id":"bee73170.35c9b","type":"sqlitedb","z":"","db":":memory:","mode":"RW"},{"id":"8aa712e4.3b9af8","type":"sqlitedb","z":"","db":"synonyms.sqlite","mode":"RO"}]